<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P 表決系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body class="bg-white text-gray-800">
  <div class="p-4 max-w-3xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <div class="text-xl font-bold">P2P 表決系統</div>
      <div id="clock" class="text-sm text-gray-500"></div>
    </div>

    <div id="loginSection" class="mb-6">
      <label class="block mb-2">輸入姓名：</label>
      <input id="nameInput" type="text" class="border p-2 rounded w-full mb-2" placeholder="請輸入姓名">
      <button id="connectBtn" class="bg-blue-500 text-white px-4 py-2 rounded">連線主辦人</button>
    </div>

    <div id="mainSection" class="hidden">
      <div class="mb-4">
        <h2 class="text-lg font-semibold mb-2">目前議題</h2>
        <div id="voteTopic" class="text-lg text-blue-700">無</div>
      </div>
      <div id="voteControls" class="flex space-x-2 mb-4">
        <button onclick="vote('yes')" class="bg-green-500 text-white px-4 py-2 rounded">同意</button>
        <button onclick="vote('no')" class="bg-red-500 text-white px-4 py-2 rounded">反對</button>
        <button onclick="vote('abstain')" class="bg-gray-500 text-white px-4 py-2 rounded">棄權</button>
      </div>
      <div class="mb-4">
        <h2 class="text-lg font-semibold mb-2">目前統計</h2>
        <div id="voteResult"></div>
        <div id="countdown" class="text-sm text-red-600"></div>
      </div>
      <div>
        <h2 class="text-lg font-semibold mb-2">已登入成員</h2>
        <ul id="userList" class="list-disc list-inside"></ul>
      </div>
    </div>

    <div id="hostSection" class="hidden mt-6">
      <h2 class="text-lg font-semibold mb-2">主辦人控制台</h2>
      <canvas id="qrCanvas" class="mb-4"></canvas>
      <input id="newTopicInput" type="text" class="border p-2 rounded w-full mb-2" placeholder="輸入新議題">
      <input id="durationInput" type="number" class="border p-2 rounded w-full mb-2" placeholder="投票時間（秒）">
      <button id="sendTopicBtn" class="bg-purple-500 text-white px-4 py-2 rounded">發佈新議題</button>
      <button id="exportBtn" class="bg-yellow-500 text-white px-4 py-2 rounded mt-2">匯出投票記錄</button>
    </div>
  </div>

  <script>
    const peer = new Peer();
    let connMap = {};
    let voteCounts = { yes: 0, no: 0, abstain: 0 };
    let userList = [];
    let voteLog = [];
    let isHost = false;
    let userName = "";
    let countdownInterval = null;

    const clock = document.getElementById("clock");
    setInterval(() => {
      const now = new Date();
      clock.textContent = now.toLocaleTimeString();
    }, 1000);

    peer.on("open", id => {
      if (location.hash === "#host") {
        isHost = true;
        document.getElementById("hostSection").classList.remove("hidden");
        QRCode.toCanvas(document.getElementById("qrCanvas"), location.href.replace("#host", "") + `#${id}`);
      } else {
        document.getElementById("connectBtn").onclick = () => {
          userName = document.getElementById("nameInput").value;
          if (!userName) return alert("請輸入姓名");
          const hostId = location.hash.slice(1);
          const conn = peer.connect(hostId);
          conn.on("open", () => {
            conn.send({ type: "join", name: userName });
            conn.on("data", handleHostData);
            window.hostConn = conn;
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("mainSection").classList.remove("hidden");
          });
        };
      }
    });

    function vote(choice) {
      if (window.hostConn) {
        window.hostConn.send({ type: "vote", choice });
      }
    }

    function handleHostData(data) {
      if (data.type === "topic") {
        document.getElementById("voteTopic").textContent = data.topic;
        document.getElementById("voteResult").textContent = "";
        document.getElementById("voteControls").classList.remove("hidden");
      } else if (data.type === "result") {
        const res = data.result;
        document.getElementById("voteResult").textContent = `同意：${res.yes}，反對：${res.no}，棄權：${res.abstain}`;
      } else if (data.type === "userList") {
        document.getElementById("userList").innerHTML = data.list.map(u => `<li>${u}</li>`).join("");
      } else if (data.type === "countdown") {
        let remaining = data.seconds;
        document.getElementById("countdown").textContent = `剩餘時間：${remaining} 秒`;
        clearInterval(countdownInterval);
        countdownInterval = setInterval(() => {
          remaining--;
          document.getElementById("countdown").textContent = `剩餘時間：${remaining} 秒`;
          if (remaining <= 0) {
            clearInterval(countdownInterval);
            document.getElementById("voteControls").classList.add("hidden");
          }
        }, 1000);
      }
    }

    if (location.hash === "#host") {
      peer.on("connection", conn => {
        conn.on("data", data => {
          if (data.type === "join") {
            connMap[data.name] = conn;
            userList.push(data.name);
            broadcast({ type: "userList", list: userList });
          } else if (data.type === "vote") {
            voteCounts[data.choice]++;
            voteLog.push({ name: Object.keys(connMap).find(k => connMap[k] === conn), choice: data.choice });
            broadcast({ type: "result", result: voteCounts });
          }
        });
      });

      document.getElementById("sendTopicBtn").onclick = () => {
        const topic = document.getElementById("newTopicInput").value;
        const duration = parseInt(document.getElementById("durationInput").value);
        voteCounts = { yes: 0, no: 0, abstain: 0 };
        voteLog.push({ topic, timestamp: new Date().toLocaleString(), type: "new" });
        broadcast({ type: "topic", topic });
        broadcast({ type: "result", result: voteCounts });
        if (!isNaN(duration)) {
          broadcast({ type: "countdown", seconds: duration });
        }
      };

      document.getElementById("exportBtn").onclick = () => {
        let txt = "所有表決記錄\n====================\n";
        voteLog.forEach(entry => {
          if (entry.type === "new") {
            txt += `\n議題：${entry.topic}\n時間：${entry.timestamp}\n------------------------\n`;
          } else {
            txt += `${entry.name}：${entry.choice === 'yes' ? '同意' : entry.choice === 'no' ? '反對' : '棄權'}\n`;
          }
        });
        txt += "------------------------\n";
        const blob = new Blob([txt], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `vote-log-${Date.now()}.txt`;
        a.click();
      };

      function broadcast(msg) {
        for (const name in connMap) {
          connMap[name].send(msg);
        }
      }
    }
  </script>
</body>
</html>
